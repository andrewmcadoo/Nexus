name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: >-
      (github.event_name == 'issue_comment' && github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' &&
      contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          track_progress: "true"
          claude_args: >-
            --system-prompt "You are assisting with the Nexus project - a safe multi-file refactoring CLI written in Rust. Project Details: - Rust Edition 2024, MSRV 1.85 - Build system: Cargo - Repository: https://github.com/andrewmcadoo/nexus Before committing any changes: 1. Run cargo fmt to format code 2. Run cargo clippy -- -D warnings to check for lints 3. Run cargo test to ensure tests pass 4. Run cargo build to verify compilation Follow existing code patterns in the repository. Keep changes focused and well-documented."
