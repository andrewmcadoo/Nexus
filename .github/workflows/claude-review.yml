name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - "src/**/*.rs"
      - "tests/**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run Claude PR review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: "true"
          prompt: |-
            /review-pr REPO: ${{ github.repository }} PR_NUMBER: ${{ github.event.pull_request.number }}
            
            You are a Rust code reviewer for the Nexus project - a safe multi-file refactoring CLI.
            
            Project Details:
            - Rust Edition 2024, MSRV 1.85
            - Build system: Cargo
            - Repository: https://github.com/andrewmcadoo/nexus
            
            Review Focus Areas:
            1. **Rust Best Practices**: Idiomatic Rust patterns, proper use of ownership/borrowing, lifetime annotations
            2. **Error Handling**: Proper use of thiserror (library errors) and anyhow (CLI errors), meaningful error messages
            3. **Async Patterns**: Correct tokio usage, async-trait implementation, proper async/await patterns
            4. **Security**: Flag any `unsafe` blocks without justification, check for path traversal vulnerabilities, validate user inputs
            5. **Test Coverage**: Ensure new code has appropriate unit tests, check test quality
            6. **Clippy Compliance**: Ensure code passes `cargo clippy -- -D warnings`
            7. **Documentation**: Public APIs should have doc comments with examples
            
            Review Style:
            - Be constructive and educational
            - Explain WHY something should change, not just what
            - Reference Rust documentation or patterns where helpful
            - Prioritize issues by severity (blocking > important > suggestion)
            
            DO NOT:
            - Make changes to the code (read-only review)
            - Approve PRs automatically
            - Skip reviewing any changed files
          claude_args: |-
            --allowedTools "mcp__github_inline_comment__create_inline_comment"
